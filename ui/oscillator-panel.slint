import { Constant } from "constants.slint";
import {
    Panel,
    PanelLabel,
    VerticalSpacer,
    HorizontalParameterSlider,
    CenteredParameterSlider,
    LabeledVerticalSlider,
    IntSpinBox,
    DropDownMenu,
    HorizontalSpacer,
    SectionLabel,
} from "components.slint";
import {
    VerticalSlider,
    HorzontalSlider,
    BalanceSlider,
} from "custom-widgets.slint";
import { Theme } from "theme.slint";

export struct Oscillator  {
    wave-shape-index: int,
    fine-tune: float,
    course-tune: int,
    clipper-boost: float,
    parameter1: float,
    parameter2: float,
}


export component OscControlsPanel inherits Panel {
    in property <Oscillator> oscillator;
    in property <string> title;
    in property <int> fine-tune-cents: 0;

    callback wave-shape-changed(int);
    callback course-tune-changed(float);
    callback fine-tune-changed(float);
    callback clipper-boost-changed(float);
    callback parameter1-changed(float);
    callback parameter2-changed(float);

    function set_parameters_from_wave_shape(shape: string) {
        if (shape == "Pulse") {
            param1.label = Theme.osc-controls-param1-pulse;
            param2.label = Theme.control-label-default-string;
            param1.enabled = true;
            param2.enabled = false;
        } else if (shape == "AM") {
            param1.label = Theme.osc-controls-param1-am;
            param2.label = Theme.osc-controls-param2-am;
            param1.enabled = true;
            param2.enabled = true;
        } else if (shape == "FM") {
            param1.label = Theme.osc-controls-param1-fm;
            param2.label = Theme.osc-controls-param2-fm;
            param1.enabled = true;
            param2.enabled = true;
        } else {
            param1.label = Theme.control-label-default-string;
            param2.label = Theme.control-label-default-string;
            param1.enabled = false;
            param2.enabled = false;
        }
    }

    init => {
        set_parameters_from_wave_shape(wave-shape.current-value);
    }

    HorizontalLayout {
        alignment: center;
        VerticalLayout {
            padding: Theme.osc-controls-panel-padding;
            spacing: Theme.osc-controls-panel-spacing;
            alignment: start;

            PanelLabel {
                label: title;
            }

            wave-shape := DropDownMenu {
                label: Theme.osc-controls-wave-shape;
                value-list: Constant.OSC_WAVE_SHAPES;
                value-index: oscillator.wave-shape-index;
                dropdown-width: Theme.oscillator-panel-widget-width;
                drop_down_changed(index, shape) => {
                    set_parameters_from_wave_shape(shape);
                    wave-shape-changed(index);
                }
            }

            course-tune := IntSpinBox {
                label: Theme.osc-controls-course-tune;
                value-units: Theme.osc-controls-semitones;
                step: 1;
                minimum: Constant.MIN_COURSE_TUNE_SEMITONES;
                maximum: Constant.MAX_COURSE_TUNE_SEMITONES;
                value: oscillator.course-tune;
                spinbox-width: Theme.oscillator-panel-widget-width;
                spinbox-changed(semitones) => {
                    course-tune-changed(semitones);
                }
            }

            fine-tune := CenteredParameterSlider {
                label: Theme.osc-controls-fine-tune;
                value: oscillator.fine-tune;
                display-value: fine-tune-cents;
                value-units: Theme.osc-controls-cents;
                show-value: true;
                slider-width: Theme.oscillator-panel-widget-width;
                centered-parameter-slider-changed(cents) => {
                    fine-tune-changed(cents);
                }
            }

            clip-boost := HorizontalParameterSlider {
                label: Theme.osc-controls-clipper-boost;
                slider-width: Theme.oscillator-panel-widget-width;
                value: oscillator.clipper-boost;
                horizontal-parameter-slider-changed(boost) => {
                    clipper-boost-changed(boost);
                }
            }

            param1 := HorizontalParameterSlider {
                slider-width: Theme.oscillator-panel-widget-width;
                value: oscillator.parameter1;
                horizontal-parameter-slider-changed(value) => {
                    parameter1-changed(value);
                }
            }

            param2 := HorizontalParameterSlider {
                slider-width: Theme.oscillator-panel-widget-width;
                value: oscillator.parameter2;
                horizontal-parameter-slider-changed(value) => {
                    parameter2-changed(value);
                }
            }
        }
    }
}

export component OscillatorsPanel inherits Panel {
    in property <[Oscillator]> oscillators;
    in property <[int]> fine-tune-cents;

    callback wave-shape-changed(int, int);
    callback course-tune-changed(int, float);
    callback fine-tune-changed(int, float);
    callback clipper-boost-changed(int, float);
    callback parameter1-changed(int, float);
    callback parameter2-changed(int, float);

    HorizontalLayout {
        padding: Theme.oscillator-panel-padding;
        spacing: Theme.oscillator-panel-spacing;

        for oscillator[index] in oscillators: OscControlsPanel {

            width: Theme.oscillator-panel-section-width;
            oscillator: oscillator;
            title: Theme.osc-controls-panel-titles[index];
            fine-tune-cents: fine-tune-cents[index];

            wave-shape-changed(int) => {
                wave-shape-changed(index, int);
            }
            course-tune-changed(float) => {
                course-tune-changed(index, float);
            }
            fine-tune-changed(float) => {
                fine-tune-changed(index, float);
            }
            clipper-boost-changed(float) => {
                clipper-boost-changed(index, float);
            }
            parameter1-changed(float) => {
                parameter1-changed(index, float);
            }
            parameter2-changed(float) => {
                parameter2-changed(index, float);
            }
        }
    }
}
